<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,OSX,lock,synchronization," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="OS X å’Œ iOS çš„å¤šçº¿ç¨‹å®‰å…¨å¼€å‘ä¸€ç›´éƒ½å®¹æ˜“æˆä¸º App å¼€å‘çš„å‘ï¼Œå¤„ç†ä¸å¥½å°±å®¹æ˜“å‡ºç° crash æˆ–å„ç§å„æ ·å¥‡æ€ªçš„ç°è±¡ï¼Œè¿™æ¬¡ä¸‹å®šå†³å¿ƒæ·±å…¥ç ”ç©¶ã€Œå¤šçº¿ç¨‹å¼€å‘ä¸­çš„åŒæ­¥å·¥å…·ã€ã€‚è‹¹æœå®˜æ–¹èµ„æ–™ æœ¬æ–‡Demo
Synchronization ToolsåŒæ­¥å·¥å…·åŒ…æ‹¬ï¼š

Atomic Operations
Memory Barriers and Volatile Variables
Locks
Condit">
<meta property="og:type" content="article">
<meta property="og:title" content="Learn Synchronization">
<meta property="og:url" content="http://yoursite.com/2017/06/01/Learn-Synchronization/index.html">
<meta property="og:site_name" content="melody5417">
<meta property="og:description" content="OS X å’Œ iOS çš„å¤šçº¿ç¨‹å®‰å…¨å¼€å‘ä¸€ç›´éƒ½å®¹æ˜“æˆä¸º App å¼€å‘çš„å‘ï¼Œå¤„ç†ä¸å¥½å°±å®¹æ˜“å‡ºç° crash æˆ–å„ç§å„æ ·å¥‡æ€ªçš„ç°è±¡ï¼Œè¿™æ¬¡ä¸‹å®šå†³å¿ƒæ·±å…¥ç ”ç©¶ã€Œå¤šçº¿ç¨‹å¼€å‘ä¸­çš„åŒæ­¥å·¥å…·ã€ã€‚è‹¹æœå®˜æ–¹èµ„æ–™ æœ¬æ–‡Demo
Synchronization ToolsåŒæ­¥å·¥å…·åŒ…æ‹¬ï¼š

Atomic Operations
Memory Barriers and Volatile Variables
Locks
Condit">
<meta property="og:image" content="https://raw.githubusercontent.com/melody5417/LearnSynchronization/master/TestDistributedLock.png">
<meta property="og:updated_time" content="2017-06-01T15:44:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learn Synchronization">
<meta name="twitter:description" content="OS X å’Œ iOS çš„å¤šçº¿ç¨‹å®‰å…¨å¼€å‘ä¸€ç›´éƒ½å®¹æ˜“æˆä¸º App å¼€å‘çš„å‘ï¼Œå¤„ç†ä¸å¥½å°±å®¹æ˜“å‡ºç° crash æˆ–å„ç§å„æ ·å¥‡æ€ªçš„ç°è±¡ï¼Œè¿™æ¬¡ä¸‹å®šå†³å¿ƒæ·±å…¥ç ”ç©¶ã€Œå¤šçº¿ç¨‹å¼€å‘ä¸­çš„åŒæ­¥å·¥å…·ã€ã€‚è‹¹æœå®˜æ–¹èµ„æ–™ æœ¬æ–‡Demo
Synchronization ToolsåŒæ­¥å·¥å…·åŒ…æ‹¬ï¼š

Atomic Operations
Memory Barriers and Volatile Variables
Locks
Condit">
<meta name="twitter:image" content="https://raw.githubusercontent.com/melody5417/LearnSynchronization/master/TestDistributedLock.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":15,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/06/01/Learn-Synchronization/"/>





  <title> Learn Synchronization | melody5417 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">melody5417</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">åšè®©è‡ªå·±ä½©æœçš„äººï½</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/01/Learn-Synchronization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="melody5417">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="melody5417">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Learn Synchronization
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-06-01T23:40:11+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/01/Learn-Synchronization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/01/Learn-Synchronization/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>OS X å’Œ iOS çš„å¤šçº¿ç¨‹å®‰å…¨å¼€å‘ä¸€ç›´éƒ½å®¹æ˜“æˆä¸º App å¼€å‘çš„å‘ï¼Œå¤„ç†ä¸å¥½å°±å®¹æ˜“å‡ºç° crash æˆ–å„ç§å„æ ·å¥‡æ€ªçš„ç°è±¡ï¼Œè¿™æ¬¡ä¸‹å®šå†³å¿ƒæ·±å…¥ç ”ç©¶ã€Œå¤šçº¿ç¨‹å¼€å‘ä¸­çš„åŒæ­¥å·¥å…·ã€ã€‚<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/ThreadSafety/ThreadSafety.html" target="_blank" rel="external">è‹¹æœå®˜æ–¹èµ„æ–™</a> <a href="https://github.com/melody5417/LearnSynchronization.git" target="_blank" rel="external">æœ¬æ–‡Demo</a></p>
<h2 id="Synchronization-Tools"><a href="#Synchronization-Tools" class="headerlink" title="Synchronization Tools"></a>Synchronization Tools</h2><p>åŒæ­¥å·¥å…·åŒ…æ‹¬ï¼š</p>
<ul>
<li>Atomic Operations</li>
<li>Memory Barriers and Volatile Variables</li>
<li>Locks</li>
<li>Conditions</li>
<li>Perform Selector Routines</li>
</ul>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦ç ”ç©¶ Locks å’Œ Conditionsã€‚</p>
<h2 id="Tips-for-Thread-Safe-Designs"><a href="#Tips-for-Thread-Safe-Designs" class="headerlink" title="Tips for Thread-Safe Designs"></a>Tips for Thread-Safe Designs</h2><h3 id="Avoid-Synchronization-Altogether"><a href="#Avoid-Synchronization-Altogether" class="headerlink" title="Avoid Synchronization Altogether"></a>Avoid Synchronization Altogether</h3><p>ä½¿ç”¨é”ä¸€å®šä¼šå¯¹æ€§èƒ½å’Œå“åº”é€Ÿåº¦æœ‰å½±å“ï¼Œæ‰€ä»¥å°½é‡è§£è€¦è®¾è®¡ï¼Œå‡å°‘äº¤äº’å’Œä¾èµ–çš„æ¨¡å—ï¼Œä»è€Œå‡å°‘é”çš„ä½¿ç”¨ã€‚</p>
<h3 id="Be-Aware-of-Threats-to-Code-Correctness"><a href="#Be-Aware-of-Threats-to-Code-Correctness" class="headerlink" title="Be Aware of Threats to Code Correctness"></a>Be Aware of Threats to Code Correctness</h3><p>çœ‹ä¸‹é¢çš„ğŸŒ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NSLock* arrayLock = GetArrayLock();</div><div class="line">NSMutableArray* myArray = GetSharedArray();</div><div class="line">id anObject;</div><div class="line"> </div><div class="line">[arrayLock lock];</div><div class="line">anObject = [myArray objectAtIndex:0];</div><div class="line">[arrayLock unlock];</div><div class="line"> </div><div class="line">[anObject doSomething];</div></pre></td></tr></table></figure>
<p>arrayæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹arrayçš„æ—¶å€™åŠ äº†é”ã€‚ä½†æ˜¯doSomthingæ–¹æ³•æ²¡æœ‰åŠ é”ï¼Œè¿™é‡Œå°±ä¼šå‡ºç°é—®é¢˜ï¼šå¦‚æœåœ¨ unlock ä¹‹åï¼Œæœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¸…ç©ºäº†arrayï¼Œarrayä¸­çš„å¯¹è±¡è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶anObjectæŒ‡å‘çš„æ˜¯éåˆæ³•çš„å†…å­˜åœ°å€ï¼Œåœ¨è°ƒç”¨doSomethingæ–¹æ³•å°±ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<p>ä¸ºäº†è§£å†³é—®é¢˜ï¼Œå¯èƒ½ä¼šç§»åŠ¨doSomethingçš„é¡ºåºï¼Œå°†å…¶ç§»å…¥é”å†…ä¿æŠ¤ã€‚ä½†æ˜¯ï¼Œæ­¤æ—¶åˆå¯èƒ½å‡ºç°å¦ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœdoSomethingæ˜¯ä¸€ä¸ªè€—æ—¶å¾ˆé•¿çš„æ–¹æ³•ï¼Œé‚£å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åœ¨äº â€œa memory management issue that is triggered only by the presence of other threads. Because it can be released by another thread, a better solution would be to retain anObject before releasing the lock. This solution addresses the real problem of the object being released and does so without introducing a potential performance penalty.â€</p>
<p>ä¿®æ­£åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">NSLock* arrayLock = GetArrayLock();</div><div class="line">NSMutableArray* myArray = GetSharedArray();</div><div class="line">id anObject;</div><div class="line"> </div><div class="line">[arrayLock lock];</div><div class="line">anObject = [myArray objectAtIndex:0];</div><div class="line">[anObject retain];</div><div class="line">[arrayLock unlock];</div><div class="line"> </div><div class="line">[anObject doSomething];</div><div class="line">[anObject release];</div></pre></td></tr></table></figure>
<p>æ›´å¤š <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/ThreadSafetySummary/ThreadSafetySummary.html#//apple_ref/doc/uid/10000057i-CH12-SW1" target="_blank" rel="external">å®˜æ–¹tips</a></p>
<h3 id="Watch-Out-for-Deadlocks-and-Livelocks"><a href="#Watch-Out-for-Deadlocks-and-Livelocks" class="headerlink" title="Watch Out for Deadlocks and Livelocks"></a>Watch Out for Deadlocks and Livelocks</h3><p><a href="http://www.cnblogs.com/ktgu/p/3529143.html" target="_blank" rel="external">æ­»é”å’Œæ´»é”çš„è§£é‡Š</a></p>
<p>å…³äºâ€œæ­»é”ä¸æ´»é”â€çš„æ¯”å–»ï¼š<br>æ­»é”ï¼šè¿é¢å¼€æ¥çš„æ±½è½¦Aå’Œæ±½è½¦Bè¿‡é©¬è·¯ï¼Œæ±½è½¦Aå¾—åˆ°äº†åŠæ¡è·¯çš„èµ„æºï¼ˆæ»¡è¶³æ­»é”å‘ç”Ÿæ¡ä»¶1ï¼šèµ„æºè®¿é—®æ˜¯æ’ä»–æ€§çš„ï¼Œæˆ‘å äº†è·¯ä½ å°±ä¸èƒ½ä¸Šæ¥ï¼Œé™¤éä½ çˆ¬æˆ‘å¤´ä¸Šå»ï¼‰ï¼Œæ±½è½¦Bå äº†æ±½è½¦Açš„å¦å¤–åŠæ¡è·¯çš„èµ„æºï¼ŒAæƒ³è¿‡å»å¿…é¡»è¯·æ±‚å¦ä¸€åŠè¢«Bå ç”¨çš„é“è·¯ï¼ˆæ­»é”å‘ç”Ÿæ¡ä»¶2ï¼šå¿…é¡»æ•´æ¡è½¦èº«çš„ç©ºé—´æ‰èƒ½å¼€è¿‡å»ï¼Œæˆ‘å·²ç»å äº†ä¸€åŠï¼Œå°¼ç›å¦ä¸€åŠçš„è·¯è¢«Bå ç”¨äº†ï¼‰ï¼ŒBè‹¥æƒ³è¿‡å»ä¹Ÿå¿…é¡»ç­‰å¾…Aè®©è·¯ï¼ŒAæ˜¯è¾†å…°åšåŸºå°¼ï¼ŒBæ˜¯å¼€å¥‡ç‘QQçš„å±Œä¸ï¼ŒAç´ è´¨æ¯”è¾ƒä½å¼€çª—å¯¹Bç‹‚éª‚ï¼šå¿«ç»™è€å­è®©å¼€ï¼ŒBå¾ˆç”Ÿæ°”ï¼Œä½ å¦ˆé€¼çš„ï¼Œè€å­å°±ä¸è®©ï¼ˆæ­»é”å‘ç”Ÿæ¡ä»¶3ï¼šåœ¨æœªä½¿ç”¨å®Œèµ„æºå‰ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å‰¥å¤ºï¼‰ï¼Œäºæ˜¯ä¸¤è€…ç›¸äº’åƒµæŒä¸€ä¸ªéƒ½èµ°ä¸äº†ï¼ˆæ­»é”å‘ç”Ÿæ¡ä»¶4ï¼šç¯è·¯ç­‰å¾…æ¡ä»¶ï¼‰ï¼Œè€Œä¸”å¯¼è‡´æ•´æ¡é“ä¸Šçš„åç»­è½¦è¾†ä¹Ÿèµ°ä¸äº†ã€‚</p>
<p>æ´»é”ï¼šé©¬è·¯ä¸­é—´æœ‰æ¡å°æ¡¥ï¼Œåªèƒ½å®¹çº³ä¸€è¾†è½¦ç»è¿‡ï¼Œæ¡¥ä¸¤å¤´å¼€æ¥ä¸¤è¾†è½¦Aå’ŒBï¼ŒAæ¯”è¾ƒç¤¼è²Œï¼Œç¤ºæ„Bå…ˆè¿‡ï¼ŒBä¹Ÿæ¯”è¾ƒç¤¼è²Œï¼Œç¤ºæ„Aå…ˆè¿‡ï¼Œç»“æœä¸¤äººä¸€ç›´è°¦è®©è°ä¹Ÿè¿‡ä¸å»ã€‚</p>
<p>The best way to avoid both deadlock and livelock situations is to take only one lock at a time. If you must acquire more than one lock at a time, you should make sure that other threads do not try to do something similar.</p>
<h2 id="Using-Locks"><a href="#Using-Locks" class="headerlink" title="Using Locks"></a>Using Locks</h2><h3 id="Using-a-POSIX-Mutex-Lock"><a href="#Using-a-POSIX-Mutex-Lock" class="headerlink" title="Using a POSIX Mutex Lock"></a>Using a POSIX Mutex Lock</h3><p>POSIX mutex lock æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;</div><div class="line">int pthread_mutex_init(pthread_mutex_t *mutex, </div><div class="line">    const pthread_mutexattr_t *attr);</div><div class="line">int pthread_mutex_destroy(pthread_mutex_t *mutex);</div><div class="line">int pthread_mutex_lock(pthread_mutex_t *mutex);</div><div class="line">int pthread_mutex_trylock(pthread_mutex_t *mutex);</div><div class="line">int pthread_mutex_unlock(pthread_mutex_t *mutex);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">TestObj *obj = [[TestObj alloc] init];</div><div class="line"></div><div class="line">   // åˆ›å»ºé”å¯¹è±¡</div><div class="line">   __block pthread_mutex_t mutex;</div><div class="line">   pthread_mutex_init(&amp;mutex, NULL);</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       pthread_mutex_lock(&amp;mutex);</div><div class="line">       [obj method1];</div><div class="line">       sleep(5);</div><div class="line">       pthread_mutex_unlock(&amp;mutex);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       pthread_mutex_lock(&amp;mutex);</div><div class="line">       [obj method2];</div><div class="line">       sleep(5);</div><div class="line">       pthread_mutex_unlock(&amp;mutex);</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-the-NSLock-Class"><a href="#Using-the-NSLock-Class" class="headerlink" title="Using the NSLock Class"></a>Using the NSLock Class</h3><p>æ‰€æœ‰é”å®é™…éƒ½æ˜¯å®ç°äº† NSLocking åè®®ï¼Œå®šä¹‰äº† lock å’Œ unlock æ–¹æ³•ã€‚<br>NSLock ç±»ä½¿ç”¨çš„æ˜¯ POSIX æ¥å®ç°å®ƒçš„é”æ“ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»åœ¨åŒä¸€çº¿ç¨‹å†…å‘é€ unlock æ¶ˆæ¯ï¼Œå¦åˆ™ä¼šå‘ç”Ÿä¸ç¡®å®šçš„æƒ…å†µã€‚NSLock ä¸èƒ½ç”¨æ¥å®ç°è¿­ä»£é”ï¼Œå› ä¸ºå¦‚æœå‘ç”Ÿä¸¤æ¬¡ lock æ¶ˆæ¯çš„è¯ï¼Œæ•´ä¸ªçº¿ç¨‹ä¼šè¢«æ°¸ä¹…é”ä½ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">TestObj *obj = [[TestObj alloc] init];</div><div class="line">   NSLock *lock = [[NSLock alloc] init];</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       [lock lock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1 lock&quot;);</div><div class="line">       [obj method1];</div><div class="line">       sleep(2);</div><div class="line">       [lock unlock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1 unLock&quot;);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       // å…ˆ sleep ä»¥ä¿è¯çº¿ç¨‹2çš„ä»£ç åæ‰§è¡Œ</div><div class="line">       sleep(1);</div><div class="line">       [lock lock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2 lock&quot;);</div><div class="line">       [obj method2];</div><div class="line">       [lock unlock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2 unLock&quot;);</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-the-synchronized-Directive"><a href="#Using-the-synchronized-Directive" class="headerlink" title="Using the @synchronized Directive"></a>Using the @synchronized Directive</h3><p>ä½œä¸ºä¸€ç§é¢„é˜²æªæ–½ï¼Œ@synchronizedå—éšå¼çš„æ·»åŠ ä¸€ä¸ªå¼‚å¸¸å¤„ç†ä¾‹ç¨‹æ¥ä¿æŠ¤ä»£ç ã€‚è¯¥å¤„ç†ä¾‹ç¨‹ä¼šåœ¨å¼‚å¸¸æŠ›å‡ºçš„æ—¶å€™è‡ªåŠ¨çš„é‡Šæ”¾äº’æ–¥é”ã€‚è¿™æ„å‘³ç€ä¸ºäº†ä½¿ç”¨@synchronizedæŒ‡ä»¤ï¼Œä½ å¿…é¡»åœ¨ä½ çš„ä»£ç ä¸­å¯ç”¨å¼‚å¸¸å¤„ç†ã€‚å¦‚æœä½ ä¸æƒ³è®©éšå¼çš„å¼‚å¸¸å¤„ç†ä¾‹ç¨‹å¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨é”çš„ç±»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">TestObj *obj = [[TestObj alloc] init];</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       @synchronized (obj) &#123;</div><div class="line">           [obj method1];</div><div class="line">           sleep(10);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       sleep(1);</div><div class="line">       @synchronized (obj) &#123;</div><div class="line">           [obj method2];</div><div class="line">       &#125;</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-an-NSRecursiveLock-Object"><a href="#Using-an-NSRecursiveLock-Object" class="headerlink" title="Using an NSRecursiveLock Object"></a>Using an NSRecursiveLock Object</h3><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">//ä¸»çº¿ç¨‹ä¸­</div><div class="line">   NSLock *theLock = [[NSLock alloc] init];</div><div class="line">   TestObj *obj = [[TestObj alloc] init];</div><div class="line"></div><div class="line">   //çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       static void(^TestMethod)(int);</div><div class="line">       TestMethod = ^(int value)</div><div class="line">       &#123;</div><div class="line">           [theLock lock];</div><div class="line">           if (value &gt; 0)</div><div class="line">           &#123;</div><div class="line">               [obj method1];</div><div class="line">               sleep(5);</div><div class="line">               TestMethod(value-1);</div><div class="line">           &#125;</div><div class="line">           [theLock unlock];</div><div class="line">       &#125;;</div><div class="line">       TestMethod(5);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   //çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       sleep(1);</div><div class="line">       [theLock lock];</div><div class="line">       [obj method2];</div><div class="line">       [theLock unlock];</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<p>è¿è¡Œè¿™æ®µä»£ç ï¼Œä¼šå‘ç°æŠ¥é”™ï¼Œå‘ç”Ÿæ­»é”ï¼š</p>
<pre><code>2017-05-31 11:54:01.467100+0800 LearnLockIniOSMultiThreading[1863:602383] method1
2017-05-31 11:54:06.471439+0800 LearnLockIniOSMultiThreading[1863:602383] *** -[NSLock lock]: deadlock (&lt;NSLock: 0x6180000c1340&gt; &apos;(null)&apos;)
2017-05-31 11:54:06.471478+0800 LearnLockIniOSMultiThreading[1863:602383] *** Break on _NSLockError() to debug.
</code></pre><p>è¿™é‡Œå°±æ˜¯ä¹‹å‰è¯´çš„ï¼ŒNSLock ä¸èƒ½ç”¨æ¥å®ç°è¿­ä»£é”ï¼Œå› ä¸ºå¦‚æœå‘ç”Ÿä¸¤æ¬¡ lock æ¶ˆæ¯çš„è¯ï¼Œæ•´ä¸ªçº¿ç¨‹ä¼šè¢«æ°¸ä¹…é”ä½ã€‚è¿™æ—¶å°±åº”è¯¥ä½¿ç”¨ NSRecursiveLockã€‚</p>
<p>NSRecursiveLockç±»å®šä¹‰äº†å¯ä»¥è¢«åŒä¸€çº¿ç¨‹è·å–å¤šæ¬¡è€Œä¸ä¼šé€ æˆæ­»é”çš„é”ã€‚NSRecursiveLockå¯ä»¥è¢«ç”¨åœ¨é€’å½’è°ƒç”¨ä¸­ï¼Œä¸€ä¸ªé€’å½’é”ä¼šè·Ÿè¸ªå®ƒè¢«å¤šå°‘æ¬¡æˆåŠŸè·å¾—äº†ã€‚æ¯æ¬¡æˆåŠŸçš„è·å¾—è¯¥é”éƒ½å¿…é¡»å¹³è¡¡è°ƒç”¨é”ä½å’Œè§£é”çš„æ“ä½œã€‚åªæœ‰æ‰€æœ‰çš„é”ä½å’Œè§£é”æ“ä½œéƒ½å¹³è¡¡çš„æ—¶å€™ï¼Œé”æ‰çœŸæ­£è¢«é‡Šæ”¾ç»™å…¶ä»–çº¿ç¨‹è·å¾—ã€‚è¿™ç§ç±»å‹çš„é”é€šå¸¸è¢«ç”¨åœ¨ä¸€ä¸ªé€’å½’å‡½æ•°é‡Œé¢æ¥é˜²æ­¢é€’å½’é€ æˆé˜»å¡çº¿ç¨‹ï¼Œåªæœ‰å½“å¤šæ¬¡è·å–çš„é”å…¨éƒ¨é‡Šæ”¾æ—¶ï¼ŒNSRecursiveLockæ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹è·å–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">//ä¸»çº¿ç¨‹ä¸­</div><div class="line">    NSRecursiveLock *theLock = [[NSRecursiveLock alloc] init];</div><div class="line">    TestObj *obj = [[TestObj alloc] init];</div><div class="line"></div><div class="line">    //çº¿ç¨‹1</div><div class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        static void(^TestMethod)(int);</div><div class="line">        TestMethod = ^(int value)</div><div class="line">        &#123;</div><div class="line">            [theLock lock];</div><div class="line">            if (value &gt; 0)</div><div class="line">            &#123;</div><div class="line">                [obj method1];</div><div class="line">                sleep(5);</div><div class="line">                TestMethod(value-1);</div><div class="line">            &#125;</div><div class="line">            [theLock unlock];</div><div class="line">        &#125;;</div><div class="line">        TestMethod(5);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    //çº¿ç¨‹2</div><div class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        sleep(1);</div><div class="line">        [theLock lock];</div><div class="line">        [obj method2];</div><div class="line">        [theLock unlock];</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>å› ä¸ºä¸€ä¸ªé€’å½’é”ä¸ä¼šè¢«é‡Šæ”¾ç›´åˆ°æ‰€æœ‰é”çš„è°ƒç”¨å¹³è¡¡ä½¿ç”¨äº†è§£é”æ“ä½œï¼Œæ‰€ä»¥ä½ å¿…é¡»ä»”ç»†æƒè¡¡æ˜¯å¦å†³å®šä½¿ç”¨é”å¯¹æ€§èƒ½çš„æ½œåœ¨å½±å“ã€‚é•¿æ—¶é—´æŒæœ‰ä¸€ä¸ªé”å°†ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹é˜»å¡ç›´åˆ°é€’å½’å®Œæˆã€‚å¦‚æœä½ å¯ä»¥é‡å†™ä½ çš„ä»£ç æ¥æ¶ˆé™¤é€’å½’æˆ–æ¶ˆé™¤ä½¿ç”¨ä¸€ä¸ªé€’å½’é”ï¼Œä½ å¯èƒ½ä¼šè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<h3 id="Using-an-NSConditionLock-Object"><a href="#Using-an-NSConditionLock-Object" class="headerlink" title="Using an NSConditionLock Object"></a>Using an NSConditionLock Object</h3><p>NSConditionLockå®šä¹‰äº†ä¸€ä¸ªæ¡ä»¶äº’æ–¥é”ï¼Œä¹Ÿå°±æ˜¯å½“æ¡ä»¶æˆç«‹æ—¶å°±ä¼šè·å–åˆ°é”ï¼Œåä¹‹å°±ä¼šé‡Šæ”¾é”ã€‚å®ƒçš„è¡Œä¸ºå’ŒCoditionæœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°éå¸¸ä¸åŒã€‚å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œæ¡ä»¶é”å¯ä»¥è¢«ç”¨åœ¨æœ‰ç‰¹å®šé¡ºåºçš„å¤„ç†æµç¨‹ä¸­ï¼Œå½“å¤šçº¿ç¨‹éœ€è¦ä»¥ç‰¹å®šçš„é¡ºåºæ¥æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªNSConditionLockå¯¹è±¡ï¼Œæ¯”å¦‚ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€‚</p>
<p>NSConditionLockçš„é”ä½å’Œè§£é”æ–¹æ³•å¯ä»¥ä»»æ„ç»„åˆä½¿ç”¨ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨unlockWithCondition:å’Œlockæ¶ˆæ¯ï¼Œæˆ–ä½¿ç”¨lockWhenCondition:å’Œunlockæ¶ˆæ¯ã€‚å½“ç„¶ï¼Œåé¢çš„ç»„åˆå¯ä»¥è§£é”ä¸€ä¸ªé”ä½†æ˜¯å¯èƒ½æ²¡æœ‰é‡Šæ”¾ä»»ä½•ç­‰å¾…æŸç‰¹å®šæ¡ä»¶å€¼çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">NSConditionLock *lock = [[NSConditionLock alloc] init];</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       for (int i = 0; i &lt;= 2; i++) &#123;</div><div class="line">           [lock lock];</div><div class="line">           NSLog(@&quot;thread1:%d&quot;, i);</div><div class="line">           sleep(2);</div><div class="line">           [lock unlockWithCondition:i];</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       [lock lockWhenCondition:2];</div><div class="line">       NSLog(@&quot;thread2&quot;);</div><div class="line">       [lock unlock];</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-an-NSDistributedLock-Object"><a href="#Using-an-NSDistributedLock-Object" class="headerlink" title="Using an NSDistributedLock Object"></a>Using an NSDistributedLock Object</h3><p>NSDistributedLockæ˜¯è·¨è¿›ç¨‹çš„åˆ†å¸ƒå¼é”ï¼Œé”æœ¬èº«æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„äº’æ–¥é”ï¼Œåº•å±‚æ˜¯ç”¨æ–‡ä»¶ç³»ç»Ÿå®ç°çš„äº’æ–¥é”ã€‚å¦‚æœPathä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨tryLockè¿”å›YESæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºpathã€‚åœ¨ç»“æŸçš„æ—¶å€™Pathä¼šè¢«æ¸…é™¤ï¼Œæ‰€ä»¥åœ¨é€‰æ‹©pathçš„æ—¶å€™ï¼Œåº”è¯¥é€‰æ‹©ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯å¾„ï¼Œä»¥é˜²æ­¢è¯¯æ“ä½œã€‚</p>
<p>NSDistributedLockæ²¡æœ‰å®ç°NSLockingåè®®ï¼Œæ‰€ä»¥æ²¡æœ‰ä¼šé˜»å¡çº¿ç¨‹çš„lockæ–¹æ³•ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯éé˜»å¡çš„tryLockæ–¹æ³•ã€‚NSDistributedLockç±»å¯ä»¥è¢«å¤šå°ä¸»æœºä¸Šçš„å¤šä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨æ¥é™åˆ¶å¯¹æŸäº›å…±äº«èµ„æºçš„è®¿é—®ã€‚å¯¹äºä¸€ä¸ªå¯ç”¨çš„NSDistributedLockå¯¹è±¡ï¼Œé”å¿…é¡»ç”±æ‰€æœ‰ä½¿ç”¨å®ƒçš„ç¨‹åºå†™å…¥ã€‚</p>
<p>NSDistributedLockåªæœ‰åœ¨é”æŒæœ‰è€…æ˜¾å¼åœ°é‡Šæ”¾åæ‰ä¼šè¢«é‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æŒæœ‰é”çš„åº”ç”¨å´©æºƒåï¼Œå…¶ä»–åº”ç”¨å°±ä¸èƒ½è®¿é—®å—ä¿æŠ¤çš„å…±äº«èµ„æºäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨breadLockæ–¹æ³•æ¥æ‰“ç ´ç°å­˜çš„é”ä»¥ä¾¿ä½ å¯ä»¥è·å–å®ƒã€‚ä½†æ˜¯é€šå¸¸åº”è¯¥é¿å…æ‰“ç ´é”ï¼Œé™¤éä½ ç¡®å®šæ‹¥æœ‰è¿›ç¨‹å·²ç»æ­»äº¡å¹¶ä¸å¯èƒ½å†é‡Šæ”¾è¯¥é”ã€‚å’Œå…¶ä»–ç±»å‹çš„é”ä¸€æ ·ï¼Œå½“ä½ ä½¿ç”¨NSDistributedLockå¯¹è±¡æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨unlockæ–¹æ³•æ¥é‡Šæ”¾å®ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">appAçš„ä»£ç ï¼š</div><div class="line">	dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        NSString *desktopPath = NSSearchPathForDirectoriesInDomains(NSDesktopDirectory, NSUserDomainMask, YES).firstObject;</div><div class="line">        NSDistributedLock *lock = [[NSDistributedLock alloc] initWithPath:[desktopPath stringByAppendingPathComponent:@&quot;testDistributedLock__&quot;]];</div><div class="line"></div><div class="line">        [lock breakLock];</div><div class="line">        [lock tryLock];</div><div class="line">        sleep(10);</div><div class="line">        [lock unlock];</div><div class="line">        NSLog(@&quot;appA OK&quot;);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">appBçš„ä»£ç ï¼š</div><div class="line">	dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">        NSString *desktopPath = NSSearchPathForDirectoriesInDomains(NSDesktopDirectory, NSUserDomainMask, YES).firstObject;</div><div class="line">        NSDistributedLock *lock = [[NSDistributedLock alloc] initWithPath:[desktopPath stringByAppendingPathComponent:@&quot;testDistributedLock__&quot;]];</div><div class="line"></div><div class="line">        while (![lock tryLock]) &#123;</div><div class="line">            NSLog(@&quot;appB waiting&quot;);</div><div class="line">            sleep(1);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [lock unlock];</div><div class="line">        NSLog(@&quot;appB OK&quot;);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚å›¾ï¼š<img src="https://raw.githubusercontent.com/melody5417/LearnSynchronization/master/TestDistributedLock.png" alt="DistributedLock"></p>
<h3 id="Using-the-NSCondition-Class"><a href="#Using-the-NSCondition-Class" class="headerlink" title="Using the NSCondition Class"></a>Using the NSCondition Class</h3><p>NSCondition æ˜¯äº’æ–¥é”å’Œæ¡ä»¶é”çš„ç»“åˆä½“ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä¿¡å·è€Œé˜»å¡æ—¶ï¼Œå¯ä»¥è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹å”¤é†’ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ“ä½œç³»ç»Ÿå®ç°çš„å·®å¼‚ï¼Œå³ä½¿åœ¨ä»£ç ä¸­æ²¡æœ‰å‘é€signalæ¶ˆæ¯ï¼Œçº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½è¢«å”¤é†’ï¼Œæ‰€ä»¥éœ€è¦å¢åŠ è°“è¯å˜é‡æ¥ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ã€‚</p>
<ul>
<li>waitï¼šé‡Šæ”¾äº’æ–¥é‡ï¼Œä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œåˆ‡æ¢åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œã€‚</li>
<li>waitUntilDateï¼šé‡Šæ”¾äº’æ–¥é‡ï¼Œä½¿å½“å‰çº¿ç¨‹ç­‰å¾…åˆ°æŸä¸€ä¸ªæ—¶é—´ï¼Œåˆ‡æ¢åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œã€‚</li>
<li>signalï¼šå”¤é†’ä¸€ä¸ªå…¶å®ƒç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹</li>
<li>broadcastï¼šå”¤é†’æ‰€æœ‰å…¶å®ƒç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">NSCondition *condition = [[NSCondition alloc] init];</div><div class="line">   NSMutableArray *products = [[NSMutableArray alloc] init];</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:before lock&quot;);</div><div class="line">       [condition lock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:after lock&quot;);</div><div class="line"></div><div class="line">       while ([products count] == 0) &#123;</div><div class="line">           NSLog(@&quot;çº¿ç¨‹1:wait&quot;);</div><div class="line">           [condition wait];</div><div class="line">       &#125;</div><div class="line">       [products removeAllObjects];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:remove&quot;);</div><div class="line">       [condition unlock];</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       sleep(1);</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2: before lock&quot;);</div><div class="line">       [condition lock];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2: after lock&quot;);</div><div class="line">       [products addObject:[NSObject new]];</div><div class="line">       [condition signal];</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2 signal&quot;);</div><div class="line">       [condition unlock];</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-POSIX-Conditions"><a href="#Using-POSIX-Conditions" class="headerlink" title="Using POSIX Conditions"></a>Using POSIX Conditions</h3><p>POSIX çº¿ç¨‹æ¡ä»¶é”éœ€è¦æ¡ä»¶é”å’Œäº’æ–¥é”é…åˆã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">__block pthread_cond_t condition;</div><div class="line">   pthread_cond_init(&amp;condition, NULL);</div><div class="line"></div><div class="line">   __block pthread_mutex_t mutex;</div><div class="line">   pthread_mutex_init(&amp;mutex, NULL);</div><div class="line"></div><div class="line">   __block Boolean ready_to_go = false;</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:before lock&quot;);</div><div class="line">       pthread_mutex_lock(&amp;mutex);</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:after lock&quot;);</div><div class="line"></div><div class="line">       while (ready_to_go == false) &#123;</div><div class="line">           NSLog(@&quot;çº¿ç¨‹1:wait&quot;);</div><div class="line">           pthread_cond_wait(&amp;condition, &amp;mutex);</div><div class="line">       &#125;</div><div class="line">       // Do work. (The mutex should stay locked.)</div><div class="line"></div><div class="line">       // Reset the predicate and release the mutex.</div><div class="line">       ready_to_go = false;</div><div class="line">       NSLog(@&quot;çº¿ç¨‹1:reset predicate&quot;);</div><div class="line">       pthread_mutex_unlock(&amp;mutex);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   // çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       sleep(1);</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2: before lock&quot;);</div><div class="line">       pthread_mutex_lock(&amp;mutex);</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2: after lock&quot;);</div><div class="line">       ready_to_go = true;</div><div class="line">       pthread_cond_signal(&amp;condition);</div><div class="line">       NSLog(@&quot;çº¿ç¨‹2 signal the other thread to begin work&quot;);</div><div class="line">       pthread_mutex_unlock(&amp;mutex);</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-GCD-dispatch-sempaphore"><a href="#Using-GCD-dispatch-sempaphore" class="headerlink" title="Using GCD dispatch_sempaphore"></a>Using GCD dispatch_sempaphore</h3><p>dispatch_sempaphore æ˜¯ GCD ç”¨æ¥åŒæ­¥çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒä¸»è¦æœ‰ä¸¤ä¸ªåº”ç”¨ï¼š ä¿æŒçº¿ç¨‹åŒæ­¥ å’Œ ä¸ºçº¿ç¨‹åŠ é”ã€‚æä¾›ä»¥ä¸‹æ–¹æ³•ï¼šï¼ˆ<a href="http://www.jianshu.com/p/a84c2bf0d77b" target="_blank" rel="external">å‚è€ƒ</a>ï¼‰</p>
<ul>
<li>dispatch_semaphore_t dispatch_semaphore_create(long value)ï¼šæ–¹æ³•æ¥æ”¶ä¸€ä¸ªlongç±»å‹çš„å‚æ•°, è¿”å›ä¸€ä¸ªdispatch_semaphore_tç±»å‹çš„ä¿¡å·é‡ï¼Œå€¼ä¸ºä¼ å…¥çš„å‚æ•°</li>
<li>long dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout)ï¼šæ¥æ”¶ä¸€ä¸ªä¿¡å·å’Œæ—¶é—´å€¼ï¼Œè‹¥ä¿¡å·çš„ä¿¡å·é‡ä¸º0ï¼Œåˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä¿¡å·é‡å¤§äº0æˆ–è€…ç»è¿‡è¾“å…¥çš„æ—¶é—´å€¼ï¼›è‹¥ä¿¡å·é‡å¤§äº0ï¼Œåˆ™ä¼šä½¿ä¿¡å·é‡å‡1å¹¶è¿”å›ï¼Œç¨‹åºç»§ç»­ä½ä¸‹æ‰§è¡Œ</li>
<li>long dispatch_semaphore_signal(dispatch_semaphore_t dsema)ï¼šä½¿ä¿¡å·é‡åŠ 1å¹¶è¿”å›</li>
</ul>
<h4 id="ä¿æŒçº¿ç¨‹åŒæ­¥"><a href="#ä¿æŒçº¿ç¨‹åŒæ­¥" class="headerlink" title="ä¿æŒçº¿ç¨‹åŒæ­¥"></a>ä¿æŒçº¿ç¨‹åŒæ­¥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</div><div class="line">   dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);</div><div class="line"></div><div class="line">   __block int j = 0;</div><div class="line">   dispatch_async(queue, ^&#123;</div><div class="line">       j = 100;</div><div class="line">       dispatch_semaphore_signal(semaphore);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">   NSLog(@&quot;finish j = %zd&quot;, j);</div></pre></td></tr></table></figure>
<p>è¿è¡Œä»£ç ï¼Œè¾“å‡º j=100ã€‚ å¦‚æœæ³¨é‡Šæ‰ wait è¿™å¥ï¼Œåˆ™è¾“å‡º j=0ã€‚<br>åŸå› ï¼šblock æ˜¯å¼‚æ­¥æ·»åŠ åˆ°å¹¶è¡Œé˜Ÿåˆ— queue é‡Œï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹æ˜¯è¶Šè¿‡ block ç›´æ¥åˆ° dispatch_semaphore_wait è¿™ä¸€è¡Œï¼Œæ­¤æ—¶ï¼Œsemaphore ä¿¡å·é‡ä¸º0ï¼Œæ—¶é—´å€¼ä¸º Foreverï¼Œæ‰€ä»¥ä¸€å®šä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œblockåˆ°å¼‚æ­¥å¹¶è¡Œé˜Ÿåˆ—æ‰§è¡Œï¼Œå‘é€signalï¼Œä½¿ä¿¡å·é‡+1ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œèµ·åˆ°äº†åŒæ­¥çš„æ•ˆæœã€‚</p>
<h4 id="ä¸ºçº¿ç¨‹åŠ é”"><a href="#ä¸ºçº¿ç¨‹åŠ é”" class="headerlink" title="ä¸ºçº¿ç¨‹åŠ é”"></a>ä¸ºçº¿ç¨‹åŠ é”</h4><p>å½“ semaphore ä¿¡å·é‡ä¸º1æ—¶,å¯ä»¥ç”¨äºåŠ é”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">TestObj *obj = [[TestObj alloc] init];</div><div class="line">   dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);</div><div class="line"></div><div class="line">   // çº¿ç¨‹1</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">       [obj method1];</div><div class="line">       sleep(10);</div><div class="line">       dispatch_semaphore_signal(semaphore);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   //çº¿ç¨‹2</div><div class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">       sleep(1);</div><div class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">       [obj method2];</div><div class="line">       dispatch_semaphore_signal(semaphore);</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-OSSpinLock"><a href="#Using-OSSpinLock" class="headerlink" title="Using OSSpinLock"></a>Using OSSpinLock</h3><p>å…ˆå£°æ˜ä¸€ä¸‹ï¼ŒOSSpinLock åœ¨iOS10 å’Œ macOS 10.12å·²ç»è¢«åºŸå¼ƒï¼Œ è‹¹æœç»™å‡ºäº†æ›¿ä»£æ–¹æ¡ˆ os_unfair_lockã€‚<a href="https://gist.github.com/steipete/36350a8a60693d440954b95ea6cbbafc" target="_blank" rel="external">å‚è€ƒ</a></p>
<p>ç°åœ¨æ¥å­¦ä¹ ä¸€ä¸‹OSSpinLockï¼Œä¸»è¦æä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li>typedef int32_t OSSpinLock;</li>
<li>bool    OSSpinLockTry( volatile OSSpinLock *__lock );</li>
<li>void    OSSpinLockLock( volatile OSSpinLock *__lock );</li>
<li>void    OSSpinLockUnlock( volatile OSSpinLock *__lock );</li>
</ul>
<p>OSSpinLockæ˜¯ä¸€ç§è‡ªæ—‹é”ï¼Œå’Œ NSLock ä¸åŒçš„æ˜¯ NSLock è¯·æ±‚åŠ é”å¤±è´¥çš„è¯ï¼Œä¼šå…ˆè½®è¯¢ï¼Œä½†ä¸€ç§’è¿‡åä¾¿ä¼šä½¿çº¿ç¨‹è¿›å…¥ waiting çŠ¶æ€ï¼Œç­‰å¾…å”¤é†’ã€‚è€Œ OSSpinLock ä¼šä¸€ç›´è½®è¯¢ï¼Œç­‰å¾…æ—¶ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºï¼Œä¸é€‚ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/OSX/" rel="tag"># OSX</a>
          
            <a href="/tags/lock/" rel="tag"># lock</a>
          
            <a href="/tags/synchronization/" rel="tag"># synchronization</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/25/New-To-iOS/" rel="next" title="New To iOS">
                <i class="fa fa-chevron-left"></i> New To iOS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/13/ios-OSX-crash/" rel="prev" title="ios/OSX crash">
                ios/OSX crash <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/06/01/Learn-Synchronization/"
           data-title="Learn Synchronization" data-url="http://yoursite.com/2017/06/01/Learn-Synchronization/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="melody5417" />
          <p class="site-author-name" itemprop="name">melody5417</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Synchronization-Tools"><span class="nav-number">1.</span> <span class="nav-text">Synchronization Tools</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tips-for-Thread-Safe-Designs"><span class="nav-number">2.</span> <span class="nav-text">Tips for Thread-Safe Designs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Avoid-Synchronization-Altogether"><span class="nav-number">2.1.</span> <span class="nav-text">Avoid Synchronization Altogether</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Be-Aware-of-Threats-to-Code-Correctness"><span class="nav-number">2.2.</span> <span class="nav-text">Be Aware of Threats to Code Correctness</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Watch-Out-for-Deadlocks-and-Livelocks"><span class="nav-number">2.3.</span> <span class="nav-text">Watch Out for Deadlocks and Livelocks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-Locks"><span class="nav-number">3.</span> <span class="nav-text">Using Locks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-a-POSIX-Mutex-Lock"><span class="nav-number">3.1.</span> <span class="nav-text">Using a POSIX Mutex Lock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-the-NSLock-Class"><span class="nav-number">3.2.</span> <span class="nav-text">Using the NSLock Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-the-synchronized-Directive"><span class="nav-number">3.3.</span> <span class="nav-text">Using the @synchronized Directive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-an-NSRecursiveLock-Object"><span class="nav-number">3.4.</span> <span class="nav-text">Using an NSRecursiveLock Object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-an-NSConditionLock-Object"><span class="nav-number">3.5.</span> <span class="nav-text">Using an NSConditionLock Object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-an-NSDistributedLock-Object"><span class="nav-number">3.6.</span> <span class="nav-text">Using an NSDistributedLock Object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-the-NSCondition-Class"><span class="nav-number">3.7.</span> <span class="nav-text">Using the NSCondition Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-POSIX-Conditions"><span class="nav-number">3.8.</span> <span class="nav-text">Using POSIX Conditions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-GCD-dispatch-sempaphore"><span class="nav-number">3.9.</span> <span class="nav-text">Using GCD dispatch_sempaphore</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¿æŒçº¿ç¨‹åŒæ­¥"><span class="nav-number">3.9.1.</span> <span class="nav-text">ä¿æŒçº¿ç¨‹åŒæ­¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸ºçº¿ç¨‹åŠ é”"><span class="nav-number">3.9.2.</span> <span class="nav-text">ä¸ºçº¿ç¨‹åŠ é”</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-OSSpinLock"><span class="nav-number">3.10.</span> <span class="nav-text">Using OSSpinLock</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">melody5417</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"melody5417"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
